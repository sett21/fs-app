# Compose V2 (без поля version)
services:
  gen:
    build:
      context: ./gen
      dockerfile: Dockerfile.gpu
    image: postcard-selfie-gen:gpu
    ports:
      - "8081:8081"
    # требуется Docker с nvidia-container-toolkit
    deploy: {}
    gpus: all
    environment:
      PYTHONUNBUFFERED: "1"

      # Torch/threads
      TORCH_THREADS: "4"
      OMP_NUM_THREADS: "1"
      OPENBLAS_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
      TOKENIZERS_PARALLELISM: "false"
      PYTORCH_CUDA_ALLOC_CONF: "max_split_size_mb:128"
      TRANSFORMERS_NO_TORCHVISION: "1"
      HF_HUB_ENABLE_HF_TRANSFER: "0"

      # SD / Inpaint
      INPAINT_REPO: "runwayml/stable-diffusion-inpainting"
      TORCH_dtype: "fp16"
      MAX_SIDE: "1600"
      STEPS: "22"
      GUIDANCE: "4.0"
      STRENGTH: "0.46"

      # Патч-инпейнт
      INPAINT_LONG: "1400"
      INPAINT_PAD_PCT: "0.08"
      MASK_GROW: "4"

      # Кромка/контакт
      RING_IN_PCT: "0.0035"
      RING_OUT_PCT: "0.010"
      EDGE_SNAP_ITERS: "2"
      RIM_SHADE: "0.045"
      SEAMLESS_EDGE: "1"

      # Детали кожи/зерно
      FINGER_DETAIL_SIGMA: "1.1"
      FINGER_DETAIL_GAIN: "0.38"
      GRAIN_STRENGTH: "0.010"

      # Эффект страницы
      PAGE_EFFECT: "1"
      PAGE_SIDE: "right"
      PAGE_INNER_PX: "14"
      PAGE_SHADE: "0.05"
      PAGE_STRIPES: "1"

      # Faceswap
      DISABLE_FACE_SWAP: "0"
      SWAP_MODE: "before"
      INSIGHTFACE_DET_SIZE: "896"
      INSIGHTFACE_DET_THRESH: "0.5"
      FACE_MODEL_PATH: "/models/inswapper_128.onnx"
      DISABLE_HANDS: "0"
      DISABLE_FACEMESH: "0"
       # расширенная маска
      SWAP_EAR_EXPAND_PX: "18"   # 14–24
      SWAP_HAIR_EXPAND_PX: "12"  # 8–16
      SWAP_CHIN_CUT_PX: "6"      # 4–10
      SWAP_POISSON_FULL: "1"     # полноразмерный Poisson поверх ext_mask
      # волосы источника (опционально)
      HAIR_FROM_SRC: "1"
      HAIR_ALPHA: "0.85"
        # микро-резкость после свопа
      SWAP_SHARP_GAIN: "0.22"

      # Отладка
      SAVE_DEBUG: "0"
      SKIP_INPAINT: "0"
      FALLBACK_INPAINT: "0"
      OUTPUT_FORMAT: "png"
      USE_CPU: "0"

      SWAP_SELECT: "center"       # варианты: center | largest | index
      SWAP_INDEX: "0"             # используется, если SWAP_SELECT=index

      # усиление заметности свопа
      SWAP_CORE_GAIN: "1.20"      # 1.0..1.5 — сильнее «ядро» лица
      SWAP_HAIR_ALPHA: "0.35"     # 0..1    — слабее волосы (меньше артефактов по линии волос)
      SWAP_CORE_DILATE: "11"      # шире ядро

      # отладка
      SWAP_DEBUG: "1"
      DEFAULT_PROMPT: >-
        photorealistic selfie; person holding a postcard; keep postcard unchanged;
        natural skin texture; soft contact shadows; realistic fingers, no blur
      NEG_PROMPT: >-
        altered postcard, changed text, hdr halos, glow edges, extra fingers,
        deformed hands, warped text, logo distortion, oversharpen, blur, artifacts

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8081/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 120s

    volumes:
      - ./gen/models:/models:ro
      - hf_cache:/root/.cache/huggingface
      - /tmp:/tmp

    restart: unless-stopped

volumes:
  hf_cache:
